import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Play, Pause, RefreshCw } from 'lucide-react';

const PendulumSimulation = () => {
  // --- State ---
  const [isPlaying, setIsPlaying] = useState(false);
  const [slowMo, setSlowMo] = useState(false);
  
  // Physics Parameters
  const GRAVITY = 9.81;
  const LENGTH = 3; // meters
  const MASS = 1;   // kg
  
  // Simulation State
  const [angle, setAngle] = useState(Math.PI / 4); 
  const [omega, setOmega] = useState(0);
  const [sliderValue, setSliderValue] = useState(45);

  const referenceEnergy = useRef(null);
  const requestRef = useRef();
  const previousTimeRef = useRef();
  const stateRef = useRef({ angle: Math.PI / 4, omega: 0 });

  // --- Physics Engine ---
  const updatePhysics = useCallback((deltaTime) => {
    let { angle: currentAngle, omega: currentOmega } = stateRef.current;
    
    // Angular acceleration
    const alpha = -(GRAVITY / LENGTH) * Math.sin(currentAngle);
    
    let nextOmega = currentOmega + alpha * deltaTime;
    let nextAngle = currentAngle + nextOmega * deltaTime;

    // Energy Correction
    const getHeight = (theta) => LENGTH * (1 - Math.cos(theta));
    const h_current = getHeight(nextAngle);
    const pe_current = MASS * GRAVITY * h_current;

    if (referenceEnergy.current === null) {
      const v_initial = nextOmega * LENGTH;
      const ke_initial = 0.5 * MASS * v_initial * v_initial;
      referenceEnergy.current = pe_current + ke_initial;
    }

    const targetTotal = referenceEnergy.current;
    let requiredKE = targetTotal - pe_current;

    if (requiredKE < 0) {
      requiredKE = 0;
      nextOmega = 0;
    } else {
      const requiredVel = Math.sqrt((2 * requiredKE) / MASS);
      const requiredOmegaMag = requiredVel / LENGTH;
      
      if (Math.abs(nextOmega) < 0.0001) {
         // turning point
      } else {
         nextOmega = Math.sign(nextOmega) * requiredOmegaMag;
      }
    }

    stateRef.current = { angle: nextAngle, omega: nextOmega };
    setAngle(nextAngle);
    setOmega(nextOmega);
    setSliderValue(nextAngle * (180 / Math.PI));

  }, []);

  // --- Animation Loop ---
  const animate = (time) => {
    if (previousTimeRef.current !== undefined) {
      const deltaTime = (time - previousTimeRef.current) / 1000;
      const timeScale = slowMo ? 0.2 : 1.0;
      const steps = 4;
      const stepTime = (deltaTime * timeScale) / steps;
      
      for (let i = 0; i < steps; i++) {
        updatePhysics(stepTime);
      }
    }
    previousTimeRef.current = time;
    requestRef.current = requestAnimationFrame(animate);
  };

  useEffect(() => {
    if (isPlaying) {
      requestRef.current = requestAnimationFrame(animate);
    } else {
      cancelAnimationFrame(requestRef.current);
      previousTimeRef.current = undefined;
    }
    return () => cancelAnimationFrame(requestRef.current);
  }, [isPlaying, slowMo, updatePhysics]);

  // --- Controls ---
  const handleSliderChange = (e) => {
    setIsPlaying(false);
    const deg = parseFloat(e.target.value);
    setSliderValue(deg);
    const rad = deg * (Math.PI / 180);
    setAngle(rad);
    setOmega(0);
    stateRef.current = { angle: rad, omega: 0 };
    const h = LENGTH * (1 - Math.cos(rad));
    referenceEnergy.current = MASS * GRAVITY * h;
  };

  const handleReset = () => {
    setIsPlaying(false);
    setSliderValue(45);
    const rad = 45 * (Math.PI / 180);
    setAngle(rad);
    setOmega(0);
    stateRef.current = { angle: rad, omega: 0 };
    const h = LENGTH * (1 - Math.cos(rad));
    referenceEnergy.current = MASS * GRAVITY * h;
  };

  // --- Visualization Data ---
  const currentHeight = LENGTH * (1 - Math.cos(angle));
  const currentPE = MASS * GRAVITY * currentHeight;
  
  let currentTotal = referenceEnergy.current;
  if (!isPlaying || currentTotal === null) {
      currentTotal = currentPE;
      referenceEnergy.current = currentPE; 
  }
  
  let currentKE = currentTotal - currentPE;
  if (currentKE < 0.01) currentKE = 0; 

  const MAX_POSSIBLE_ENERGY = MASS * GRAVITY * LENGTH; 
  const getBarWidth = (energy) => {
      const percent = (energy / MAX_POSSIBLE_ENERGY) * 100;
      return Math.min(100, Math.max(0, percent));
  };

  const bobX = Math.sin(angle) * 250; 
  const bobY = Math.cos(angle) * 250;

  // --- Styles ---
  const styles = {
    container: {
      fontFamily: 'system-ui, -apple-system, sans-serif',
      maxWidth: '900px',
      margin: '0 auto',
      padding: '20px',
      backgroundColor: '#f8fafc',
      borderRadius: '12px',
      border: '1px solid #e2e8f0',
      boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
    },
    header: {
      textAlign: 'center',
      marginBottom: '20px',
    },
    title: {
      fontSize: '24px',
      fontWeight: 'bold',
      color: '#1e293b',
      margin: '0 0 8px 0',
    },
    subtitle: {
      color: '#64748b',
      margin: 0,
    },
    mainLayout: {
      display: 'flex',
      flexDirection: 'row',
      gap: '24px',
      flexWrap: 'wrap',
    },
    simBox: {
      flex: '1',
      minWidth: '300px',
      backgroundColor: 'white',
      borderRadius: '8px',
      border: '1px solid #e2e8f0',
      height: '320px',
      position: 'relative',
      overflow: 'hidden',
    },
    graphBox: {
      width: '250px',
      flexShrink: 0,
      display: 'flex',
      flexDirection: 'column',
      justifyContent: 'center',
      gap: '16px',
      padding: '16px',
      backgroundColor: 'white',
      borderRadius: '8px',
      border: '1px solid #e2e8f0',
    },
    labelRow: {
      display: 'flex',
      justifyContent: 'space-between',
      fontSize: '12px',
      fontWeight: 'bold',
      color: '#334155',
      marginBottom: '4px',
      textTransform: 'uppercase',
    },
    barContainer: {
      width: '100%',
      height: '32px',
      backgroundColor: '#f1f5f9',
      borderRadius: '6px',
      overflow: 'hidden',
      border: '1px solid #e2e8f0',
      position: 'relative',
    },
    bar: {
      height: '100%',
      transition: 'width 0.1s linear',
    },
    controls: {
      marginTop: '24px',
      padding: '16px',
      backgroundColor: 'white',
      borderRadius: '8px',
      border: '1px solid #e2e8f0',
    },
    sliderContainer: {
      marginBottom: '16px',
    },
    sliderLabel: {
      display: 'block',
      fontSize: '14px',
      fontWeight: '600',
      color: '#334155',
      marginBottom: '8px',
    },
    slider: {
      width: '100%',
      height: '8px',
      backgroundColor: '#e2e8f0',
      borderRadius: '4px',
      outline: 'none',
      cursor: 'pointer',
    },
    buttonRow: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      borderTop: '1px solid #f1f5f9',
      paddingTop: '16px',
    },
    btnGroup: {
      display: 'flex',
      gap: '12px',
    },
    playBtn: {
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      padding: '12px 24px',
      borderRadius: '8px',
      border: 'none',
      color: 'white',
      fontWeight: 'bold',
      cursor: 'pointer',
      backgroundColor: isPlaying ? '#f59e0b' : '#2563eb',
    },
    resetBtn: {
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      padding: '12px 16px',
      borderRadius: '8px',
      border: '2px solid #e2e8f0',
      backgroundColor: 'white',
      color: '#334155',
      fontWeight: '600',
      cursor: 'pointer',
    },
    checkboxWrapper: {
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      padding: '8px 12px',
      backgroundColor: '#f8fafc',
      borderRadius: '8px',
      border: '1px solid #e2e8f0',
    }
  };

  return (
    <div style={styles.container}>
      
      <div style={styles.header}>
        <h2 style={styles.title}>Conservation of Energy</h2>
        <p style={styles.subtitle}>Use the slider to set the starting height.</p>
      </div>

      <div style={styles.mainLayout}>
        
        {/* Simulation Area */}
        <div style={styles.simBox}>
          <svg viewBox="-300 -50 600 400" style={{ width: '100%', height: '100%' }}>
            <line x1="-100" y1="0" x2="100" y2="0" stroke="#334155" strokeWidth="4" strokeLinecap="round" />
            <line x1="0" y1="0" x2={bobX} y2={bobY} stroke="#94a3b8" strokeWidth="3" />
            <circle cx={bobX} cy={bobY} r="25" fill="#3b82f6" stroke="#1e40af" strokeWidth="2" />
          </svg>
          
          {!isPlaying && (
            <div style={{
              position: 'absolute', top: '16px', right: '16px',
              backgroundColor: '#f1f5f9', padding: '4px 12px',
              borderRadius: '999px', fontSize: '12px', color: '#64748b',
              border: '1px solid #e2e8f0', fontFamily: 'monospace'
            }}>
              {Math.round(sliderValue)}째
            </div>
          )}
        </div>

        {/* Graphs Area */}
        <div style={styles.graphBox}>
          {/* Total Energy */}
          <div>
            <div style={styles.labelRow}>
              <span>Total</span>
              <span>{currentTotal?.toFixed(1)} J</span>
            </div>
            <div style={styles.barContainer}>
               <div style={{
                 position: 'absolute', top: 0, bottom: 0, 
                 borderRight: '2px dashed #cbd5e1', zIndex: 10,
                 left: `${getBarWidth(currentTotal)}%` 
               }}></div>
              <div style={{ ...styles.bar, width: `${getBarWidth(currentTotal)}%`, backgroundColor: '#22c55e' }} />
            </div>
          </div>

          {/* Kinetic Energy */}
          <div>
            <div style={styles.labelRow}>
              <span>Kinetic</span>
              <span>{currentKE.toFixed(1)} J</span>
            </div>
            <div style={styles.barContainer}>
              <div style={{ ...styles.bar, width: `${getBarWidth(currentKE)}%`, backgroundColor: '#ef4444' }} />
            </div>
          </div>

          {/* Potential Energy */}
          <div>
            <div style={styles.labelRow}>
              <span>Potential</span>
              <span>{currentPE.toFixed(1)} J</span>
            </div>
            <div style={styles.barContainer}>
              <div style={{ ...styles.bar, width: `${getBarWidth(currentPE)}%`, backgroundColor: '#3b82f6' }} />
            </div>
          </div>
        </div>
      </div>

      {/* Control Panel */}
      <div style={styles.controls}>
        
        <div style={styles.sliderContainer}>
          <label htmlFor="angle-slider" style={styles.sliderLabel}>Set Initial Angle</label>
          <input
            id="angle-slider"
            type="range"
            min="-90"
            max="90"
            step="1"
            value={sliderValue}
            onChange={handleSliderChange}
            disabled={isPlaying}
            style={styles.slider}
          />
          <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#94a3b8', marginTop: '4px' }}>
            <span>-90째</span>
            <span>0째</span>
            <span>+90째</span>
          </div>
        </div>

        <div style={styles.buttonRow}>
            <div style={styles.btnGroup}>
                <button onClick={() => setIsPlaying(!isPlaying)} style={styles.playBtn}>
                    {isPlaying ? <><Pause size={20} /> Pause</> : <><Play size={20} /> Play</>}
                </button>

                <button onClick={handleReset} style={styles.resetBtn}>
                    <RefreshCw size={20} /> Reset
                </button>
            </div>

            <div style={styles.checkboxWrapper}>
                <input 
                    type="checkbox" 
                    id="slowmo" 
                    checked={slowMo} 
                    onChange={(e) => setSlowMo(e.target.checked)}
                    style={{ width: '20px', height: '20px', cursor: 'pointer' }}
                />
                <label htmlFor="slowmo" style={{ fontSize: '14px', color: '#334155', cursor: 'pointer' }}>Slow Motion</label>
            </div>
        </div>
      </div>

    </div>
  );
};

export default PendulumSimulation;