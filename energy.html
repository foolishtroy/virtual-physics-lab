import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Play, Pause, RefreshCw } from 'lucide-react';

const PendulumSimulation = () => {
  // --- State ---
  const [isPlaying, setIsPlaying] = useState(false);
  const [slowMo, setSlowMo] = useState(false);
  
  // Physics Parameters
  const GRAVITY = 9.81;
  const LENGTH = 3; // meters
  const MASS = 1;   // kg
  
  // Simulation State
  // angle is in radians. 0 is straight down.
  const [angle, setAngle] = useState(Math.PI / 4); 
  const [omega, setOmega] = useState(0);
  
  // Slider State (for UI sync) - stored in degrees for the input
  const [sliderValue, setSliderValue] = useState(45);

  // We store the "Reference Energy" - the total energy the system SHOULD have.
  const referenceEnergy = useRef(null);
  
  // Refs for animation loop
  const requestRef = useRef();
  const previousTimeRef = useRef();
  const stateRef = useRef({ angle: Math.PI / 4, omega: 0 });

  // --- Physics Engine (Energy Corrected) ---
  const updatePhysics = useCallback((deltaTime) => {
    let { angle: currentAngle, omega: currentOmega } = stateRef.current;
    
    // 1. Standard Gravity Step (Integration)
    // Angular acceleration = - (g/L) * sin(theta)
    const alpha = -(GRAVITY / LENGTH) * Math.sin(currentAngle);
    
    let nextOmega = currentOmega + alpha * deltaTime;
    let nextAngle = currentAngle + nextOmega * deltaTime;

    // 2. ENERGY CORRECTION (The "Artificial Freeze")
    const getHeight = (theta) => LENGTH * (1 - Math.cos(theta));
    const h_current = getHeight(nextAngle);
    const pe_current = MASS * GRAVITY * h_current;

    // Initialize Reference Energy if needed
    if (referenceEnergy.current === null) {
      const v_initial = nextOmega * LENGTH;
      const ke_initial = 0.5 * MASS * v_initial * v_initial;
      referenceEnergy.current = pe_current + ke_initial;
    }

    // 3. Force Conservation
    const targetTotal = referenceEnergy.current;
    let requiredKE = targetTotal - pe_current;

    // Clamp for floating point errors or overshooting max height
    if (requiredKE < 0) {
      requiredKE = 0;
      nextOmega = 0;
    } else {
      // Reverse engineer velocity from Energy
      // KE = 1/2 m v^2  ->  v = sqrt(2*KE/m)
      const requiredVel = Math.sqrt((2 * requiredKE) / MASS);
      const requiredOmegaMag = requiredVel / LENGTH;
      
      // Apply magnitude, keep direction
      if (Math.abs(nextOmega) < 0.0001) {
         // do nothing, let gravity pull it back
      } else {
         nextOmega = Math.sign(nextOmega) * requiredOmegaMag;
      }
    }

    stateRef.current = { angle: nextAngle, omega: nextOmega };
    setAngle(nextAngle);
    setOmega(nextOmega);
    
    // Update slider to match animation
    setSliderValue(nextAngle * (180 / Math.PI));

  }, []);

  // --- Animation Loop ---
  const animate = (time) => {
    if (previousTimeRef.current !== undefined) {
      const deltaTime = (time - previousTimeRef.current) / 1000;
      const timeScale = slowMo ? 0.2 : 1.0;
      const steps = 4; // Sub-steps for smoothness
      const stepTime = (deltaTime * timeScale) / steps;
      
      for (let i = 0; i < steps; i++) {
        updatePhysics(stepTime);
      }
    }
    previousTimeRef.current = time;
    requestRef.current = requestAnimationFrame(animate);
  };

  useEffect(() => {
    if (isPlaying) {
      requestRef.current = requestAnimationFrame(animate);
    } else {
      cancelAnimationFrame(requestRef.current);
      previousTimeRef.current = undefined;
    }
    return () => cancelAnimationFrame(requestRef.current);
  }, [isPlaying, slowMo, updatePhysics]);


  // --- Controls ---
  const handleSliderChange = (e) => {
    setIsPlaying(false);
    
    const deg = parseFloat(e.target.value);
    setSliderValue(deg);
    
    const rad = deg * (Math.PI / 180);
    setAngle(rad);
    setOmega(0);
    
    stateRef.current = { angle: rad, omega: 0 };
    
    // Reset Reference Energy immediately based on slider position
    const h = LENGTH * (1 - Math.cos(rad));
    referenceEnergy.current = MASS * GRAVITY * h;
  };

  const handleReset = () => {
    setIsPlaying(false);
    setSliderValue(45);
    const rad = 45 * (Math.PI / 180);
    setAngle(rad);
    setOmega(0);
    stateRef.current = { angle: rad, omega: 0 };
    
    const h = LENGTH * (1 - Math.cos(rad));
    referenceEnergy.current = MASS * GRAVITY * h;
  };

  // --- Visualization Data ---
  const currentHeight = LENGTH * (1 - Math.cos(angle));
  const currentPE = MASS * GRAVITY * currentHeight;
  
  // Calculate Total Energy
  let currentTotal = referenceEnergy.current;
  if (!isPlaying || currentTotal === null) {
      currentTotal = currentPE;
      referenceEnergy.current = currentPE; 
  }
  
  let currentKE = currentTotal - currentPE;
  if (currentKE < 0.01) currentKE = 0; 

  // --- Scaling Logic ---
  // Max height is at 90 degrees = LENGTH.
  // Max Energy = m * g * LENGTH
  const MAX_POSSIBLE_ENERGY = MASS * GRAVITY * LENGTH; 
  
  const getBarWidth = (energy) => {
      // Calculate percentage against the absolute max energy (90 degrees)
      const percent = (energy / MAX_POSSIBLE_ENERGY) * 100;
      return Math.min(100, Math.max(0, percent));
  };

  // SVG Coordinates
  const pivotX = 0;
  const pivotY = 0;
  const bobX = Math.sin(angle) * 250; 
  const bobY = Math.cos(angle) * 250;

  return (
    <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 md:p-6 bg-slate-50 rounded-xl shadow-lg border border-slate-200 font-sans touch-manipulation">
      
      <div className="mb-4 text-center">
        <h2 className="text-2xl font-bold text-slate-800">Conservation of Energy</h2>
        <p className="text-slate-600 text-sm md:text-base">Use the slider to set the starting height.</p>
      </div>

      <div className="flex flex-col md:flex-row w-full gap-6">
        
        {/* Simulation Area */}
        <div className="relative flex-1 bg-white rounded-lg shadow-inner border border-slate-200 h-80 overflow-hidden">
          <svg viewBox="-300 -50 600 400" className="w-full h-full">
            {/* Ceiling */}
            <line x1="-100" y1="0" x2="100" y2="0" stroke="#334155" strokeWidth="4" strokeLinecap="round" />
            {/* String */}
            <line x1={pivotX} y1={pivotY} x2={bobX} y2={bobY} stroke="#94a3b8" strokeWidth="3" />
            {/* Bob */}
            <circle cx={bobX} cy={bobY} r="25" fill="#3b82f6" stroke="#1e40af" strokeWidth="2" />
          </svg>
          
          {/* Angle Indicator (Only show when paused to avoid clutter) */}
          {!isPlaying && (
            <div className="absolute top-4 right-4 bg-slate-100 px-3 py-1 rounded-full text-xs font-mono text-slate-500 border border-slate-200">
              {Math.round(sliderValue)}째
            </div>
          )}
        </div>

        {/* Graphs Area */}
        <div className="w-full md:w-64 flex flex-col justify-center gap-4 p-4 bg-white rounded-lg shadow-sm border border-slate-200">
          {/* Total Energy */}
          <div className="flex flex-col gap-1">
            <div className="flex justify-between text-xs font-bold text-slate-700 uppercase tracking-wider">
              <span>Total</span>
              <span>{currentTotal?.toFixed(1)} J</span>
            </div>
            <div className="w-full h-8 bg-slate-100 rounded-md overflow-hidden border border-slate-200 relative">
               {/* Reference Line */}
               <div className="absolute top-0 bottom-0 border-r-2 border-dashed border-slate-300 z-10" style={{ left: `${getBarWidth(currentTotal)}%` }}></div>
              <div 
                className="h-full bg-green-500 transition-all duration-75 ease-linear"
                style={{ width: `${getBarWidth(currentTotal)}%` }}
              />
            </div>
          </div>

          {/* Kinetic Energy */}
          <div className="flex flex-col gap-1">
            <div className="flex justify-between text-xs font-bold text-slate-700 uppercase tracking-wider">
              <span>Kinetic</span>
              <span>{currentKE.toFixed(1)} J</span>
            </div>
            <div className="w-full h-8 bg-slate-100 rounded-md overflow-hidden border border-slate-200">
              <div 
                className="h-full bg-red-500 transition-all duration-75 ease-linear"
                style={{ width: `${getBarWidth(currentKE)}%` }}
              />
            </div>
          </div>

          {/* Potential Energy */}
          <div className="flex flex-col gap-1">
            <div className="flex justify-between text-xs font-bold text-slate-700 uppercase tracking-wider">
              <span>Potential</span>
              <span>{currentPE.toFixed(1)} J</span>
            </div>
            <div className="w-full h-8 bg-slate-100 rounded-md overflow-hidden border border-slate-200">
              <div 
                className="h-full bg-blue-500 transition-all duration-75 ease-linear"
                style={{ width: `${getBarWidth(currentPE)}%` }}
              />
            </div>
          </div>
        </div>
      </div>

      {/* Control Panel */}
      <div className="w-full mt-6 p-4 bg-white rounded-lg border border-slate-200 flex flex-col gap-4">
        
        {/* Slider */}
        <div className="flex flex-col gap-2">
          <label htmlFor="angle-slider" className="text-sm font-semibold text-slate-700">Set Initial Angle</label>
          <input
            id="angle-slider"
            type="range"
            min="-90"
            max="90"
            step="1"
            value={sliderValue}
            onChange={handleSliderChange}
            disabled={isPlaying}
            className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
          />
          <div className="flex justify-between text-xs text-slate-400 font-mono">
            <span>-90째</span>
            <span>0째</span>
            <span>+90째</span>
          </div>
        </div>

        {/* Buttons */}
        <div className="flex items-center justify-between pt-2 border-t border-slate-100">
            <div className="flex gap-3">
                <button
                    onClick={() => setIsPlaying(!isPlaying)}
                    className={`flex items-center gap-2 px-6 py-3 rounded-lg text-white font-bold shadow-sm transition-all active:scale-95 ${isPlaying ? 'bg-amber-500 hover:bg-amber-600' : 'bg-blue-600 hover:bg-blue-700'}`}
                >
                    {isPlaying ? <><Pause size={20} /> Pause</> : <><Play size={20} /> Play</>}
                </button>

                <button
                    onClick={handleReset}
                    className="flex items-center gap-2 px-4 py-3 bg-white border-2 border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-colors font-semibold active:scale-95"
                >
                    <RefreshCw size={20} /> Reset
                </button>
            </div>

            <div className="flex items-center gap-2 px-3 py-2 bg-slate-50 rounded-lg border border-slate-200">
                <input 
                    type="checkbox" 
                    id="slowmo" 
                    checked={slowMo} 
                    onChange={(e) => setSlowMo(e.target.checked)}
                    className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                />
                <label htmlFor="slowmo" className="text-sm text-slate-700 font-medium cursor-pointer select-none">Slow Motion</label>
            </div>
        </div>
      </div>

    </div>
  );
};

export default PendulumSimulation;